#!/usr/bin/env zsh
########################################
# function UsageMsg
########################################
function UsageMsg(){
    cat <<-EOF
	
	Usage : date_stamp.sh
	        
	        date_stamp.sh interval_sec freq_num total_time(minutes) output_dir
	        date_stamp.sh [ [34;1m-h[m ]
	
	EOF

}

########################################
# function HelpMsg
########################################
function HelpMsg(){
    #PAGERå¤‰æ•°ã®è¨­å®šå–ã‚Šè¾¼ã¿
    source $(cd ${CURRENT_SCRIPT%/*};pwd)/"common_def.sh"
    export LC_ALL=ja_JP.utf8
    ${=PAGER} <<-EOF
	
	
	[32;1;4m#### resstat package manual ####[m
	
	
	[36;1mUsage: date_stamp.sh [m  -- å®Ÿè¡Œæ—¥ä»˜ã¨æ™‚é–“ã€åŠã³èµ·å‹•å›žæ•°ã®è¨˜éŒ²
	
	       date_stamp.sh interval_sec freq_num total_time(minutes) output_dir
	       date_stamp.sh [ [34;1m-h[m ]
	
	
	[36;1m[Args] : [m
	       
	       [35;1minterval_sec[m : ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆèµ·å‹•é–“éš”ï¼ˆç§’ï¼‰
	       
	       [35;1mfreq_num[m : ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆèµ·å‹•å›žæ•°
	       
	       [35;1mtotal_time(minutes)[m : ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆèµ·å‹•æ™‚é–“ï¼ˆåˆ†ï¼‰
	       
	       [35;1moutput_dir[m : æ—¥ä»˜ã€æ™‚é–“ã€èµ·å‹•å›žæ•°æƒ…å ±ã®å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
	
	
	[36;1m[Options] : [m

	       [34;1m-h[m : ãƒ˜ãƒ«ãƒ—
	
	
	[36;1m[Overview] : [m
	
	       ç¾åœ¨æ—¥æ™‚ã€èµ·å‹•é–“éš”ã€èµ·å‹•å›žæ•°æƒ…å ±ã‚’ã€
	       time_stamp.txtã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«åã§ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›ã™ã‚‹ã€‚
	       æ ¼ç´ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯å¼•æ•°ã§æŒ‡å®šã™ã‚‹ã€‚
	       ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã€‚ï¼ˆ1è¡Œã®ã¿ï¼‰
	       [ç¾åœ¨æ—¥æ™‚(YYYY/MM/DD HH24:MI:SS)] [èµ·å‹•é–“éš”] [èµ·å‹•å›žæ•°]
	       
	       ã¾ãŸã€ç¾åœ¨æ—¥æ™‚ã¨èµ·å‹•æ™‚é–“ã‹ã‚‰ç®—å‡ºã—ãŸã€ã€Œè·¨ãå¯èƒ½æ€§ã®ã‚ã‚‹æ—¥ä»˜ã€ã‚’ã€
	       date_stamp.txtã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«åã§ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›ã™ã‚‹ã€‚
	       ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã¯ã€YYYY/MM/DDå½¢å¼ã§1è¡Œã«1æ—¥ãšã¤å‡ºåŠ›ã—ã¦ã„ãã€‚
	       
	       
	[31;1m[Caution] : [m
	
	       [35;1mï¼‘ï¼Žå‘¼ã³å‡ºã—å…ƒã¨ä½¿ç”¨å…ˆ[m
	           ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯resstat.shã®èµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚
	           ãƒ¦ãƒ¼ã‚¶ãŒè‡ªã‚‰å®Ÿè¡Œã—ãªãã¨ã‚‚ã‚ˆã„ã€‚
	           å‡ºåŠ›ã•ã‚ŒãŸèµ·å‹•æƒ…å ±ã¯ã€gnuplot_normal.shã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã€‚
	           å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚’ä¿®æ­£ã™ã‚‹éš›ã¯ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã®æ•´åˆæ€§ã‚’å–ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
	
	
	[36;1m[Author & Copyright] : [m
	        
	        resstat version ${RESSTAT_VERSION}.
	        
	        Author : Written by ${RESSTAT_AUTHOR}.
	        
	        Report bugs to <${RESSTAT_REPORT_TO}>.
	        
	        Release : ${RESSTAT_LASTUPDATE}.
	
	
	EOF

}

########################################
# function Error_clean
########################################
#Error_clean() {
    #å‰²ã‚Šè¾¼ã¿æ™‚ã®ã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç”¨ï¼ˆæœªå®Ÿè£…ï¼‰
    #startå¾Œã«å‰²ã‚Šè¾¼ã¾ã‚ŒãŸã‚‰stopã™ã¹ã
    
#}


########################################
#
# zshã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# date_stamp.sh
#
# [æ¦‚è¦]
#    æŒ‡å®šã•ã‚ŒãŸæ™‚é–“ï¼ˆå˜ä½ï¼šåˆ†ï¼‰ã‚’å…ƒã«ã€ç¾åœ¨æ™‚åˆ»ã‹ã‚‰æŒ‡å®šæ™‚é–“ã®é–“ã«å¤‰ã‚ã‚Šã†ã‚‹æ—¥ä»˜ã‚’é †ã«date_stamp.txtã«å‡ºåŠ›ã™ã‚‹ã€‚
#    ã¾ãŸã€æŒ‡å®šã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ç§’æ•°ã¨èµ·å‹•å›žæ•°ã€ã•ã‚‰ã«ç¾åœ¨æ™‚åˆ»ã‚’åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã§åŒºåˆ‡ã£ã¦time_stamp.txtã«å‡ºåŠ›ã™ã‚‹ã€‚
# [èµ·å‹•æ¡ä»¶ã€ä»•æ§˜]
# [å¼•æ•°]
#    UsageMsg()ã€HelpMsg()å‚ç…§ã€‚
#
########################################

#éžã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#éžã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œåé€€é¿
CURRENT_SCRIPT="$0"

########################################
# ã‚ªãƒ—ã‚·ãƒ§ãƒ³/å¼•æ•°è¨­å®š
########################################
# ã‚³ãƒžãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
while getopts :h ARG
do
    case "${ARG}" in
        h)
          HelpMsg
          exit 0
        ;;
        \?)
          # è§£æžå¤±æ•—æ™‚ã«ä¸Žãˆã‚‰ã‚Œã‚‹ã®ã¯ã€Œ?ã€ã€‚
          UsageMsg
          exit 4
        ;;
    esac
done

shift $(( OPTIND - 1 ))


########################################
# ã‚³ãƒžãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ãƒã‚§ãƒƒã‚¯ï¼ˆ1st Argsã€2nd Argsã€3rd Argsã€4th Argså¿…é ˆï¼‰
if [[ -z "$1" || -z "$2" || -z "$3" || -z "$4"  ]];then
    UsageMsg
    exit 4
fi

INTERVAL_SEC="$1"

FREQ="$2"

TOTAL_TIME="$3"

if [[ -e "$4" ]];then
    if [[ ! -d "$4" ]];then
       echo -e "Error : date_stamp.sh : this output directory [$4] , already used for other file name"
       exit 4
   fi
else
    mkdir -m 0777 "$4"
    CMDRET=$?
    if [[ ${CMDRET} -ne 0 ]];then
        echo -e "Error : date_stamp.sh : make directory output miss [$4]"
        exit 4
    fi
fi
OUTPUT_DIR="${4%/}"


########################################
# å¤‰æ•°å®šç¾©
########################################
#å…±é€šã®å¤‰æ•°ãŒæœªå–ã‚Šè¾¼ã¿ãªã‚‰å–ã‚Šè¾¼ã‚€
if [[ -z "${COMMON_DEF_ON}" ]];then
    #ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ ¼ç´ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª(çµ¶å¯¾ãƒ‘ã‚¹)
    BIN_PWD=($(cd ${0%/*};pwd))
    export BIN_DIR=${BIN_PWD}
    COMMON_DEF="common_def.sh"
    source ${BIN_DIR}/${COMMON_DEF}
fi

#å…±é€šé–¢æ•°ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å–ã‚Šè¾¼ã¿ï¼ˆå…¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…±é€šï¼‰
COMMON_SCRIPT="common.sh"
source ${BIN_DIR}/${COMMON_SCRIPT}

########################################
# ç¾åœ¨æ—¥ä»˜ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã€èµ·å‹•å›žæ•°ã®å‡ºåŠ›
########################################
# ã€æ³¨æ„ã€‘
# gnuplot_normal.shã«å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆãŒç›´æŽ¥é–¢ã‚ã£ã¦ã„ã‚‹ã€‚ä¿®æ­£æ™‚ã«ã¯ãã¡ã‚‰ã‚‚åŒæœŸã‚’å–ã‚‹ã“ã¨ã€‚
echo $(date "+%Y/%m/%d %H:%M:%S") ${INTERVAL_SEC} ${FREQ} > "${OUTPUT_DIR}/${TIME_STAMP_FNAME}"

########################################
# å¿…è¦ãªæ—¥ä»˜ã®å‡ºåŠ›
########################################
# å®Ÿè¡Œæ—¥ä»˜å–å¾—
TODAYS_DATE=$(date "+%Y/%m/%d")

# å¯èƒ½æ€§ã®ã‚ã‚‹æ—¥æ•°ã‚’å–å¾—
DATE_RANGE=$(( ( TOTAL_TIME / 1440 ) + 1 ))

# ç¾åœ¨ã®æ—¥æ™‚ã‹ã‚‰æŒ‡å®šæ—¥æ•°åˆ†ã¾ã§å…ˆã®æ—¥ä»˜ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã™ã‚‹ã€‚
CNT=0
while [[ ${CNT} -le ${DATE_RANGE} ]]
do
    date -d "${CNT}"' days' "+%Y/%m/%d" >> "${OUTPUT_DIR}/${DATE_STAMP_FNAME}"
    CNT=$(( CNT + 1 ))
done

exit 0

